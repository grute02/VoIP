<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIM Box íƒì§€ ì‹œìŠ¤í…œ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; }

    header {
      background: #1e293b;
      padding: 16px 32px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid #334155;
    }
    header h1 { font-size: 18px; font-weight: 600; }
    .status-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 6px #22c55e;
    }

    main { padding: 28px 32px; }

    /* í†µê³„ ì¹´ë“œ */
    .cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 28px;
    }
    .card {
      background: #1e293b;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #334155;
    }
    .card .label { font-size: 12px; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; letter-spacing: .05em; }
    .card .value { font-size: 32px; font-weight: 700; }
    .card.fraud   .value { color: #f87171; }
    .card.normal  .value { color: #4ade80; }
    .card.latency .value { color: #60a5fa; }
    .card.jitter  .value { color: #f59e0b; }

    /* ì°¨íŠ¸ + ì—…ë¡œë“œ */
    .mid-row {
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 16px;
      margin-bottom: 28px;
    }
    .panel {
      background: #1e293b;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #334155;
    }
    .panel h2 { font-size: 14px; font-weight: 600; margin-bottom: 16px; color: #94a3b8; }

    /* ì—…ë¡œë“œ í¼ */
    .upload-zone {
      border: 2px dashed #334155;
      border-radius: 10px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: border-color .2s;
    }
    .upload-zone:hover { border-color: #60a5fa; }
    .upload-zone p { font-size: 13px; color: #64748b; margin-top: 8px; }
    #pcap-file { display: none; }

    .radio-group { display: flex; gap: 12px; justify-content: center; margin: 14px 0; }
    .radio-group label { font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; }

    .btn {
      width: 100%;
      padding: 10px;
      background: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s;
    }
    .btn:hover { background: #2563eb; }
    .btn:disabled { background: #334155; cursor: not-allowed; }

    #upload-result {
      margin-top: 12px;
      font-size: 13px;
      min-height: 20px;
      text-align: center;
    }
    .ok   { color: #4ade80; }
    .warn { color: #f59e0b; }
    .err  { color: #f87171; }

    /* ì„¸ì…˜ í…Œì´ë¸” */
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th {
      text-align: left;
      padding: 10px 12px;
      color: #64748b;
      font-weight: 500;
      border-bottom: 1px solid #334155;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .05em;
    }
    td { padding: 10px 12px; border-bottom: 1px solid #1e293b; }
    tr:hover td { background: #1e293b; }

    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-fraud  { background: #450a0a; color: #f87171; }
    .badge-normal { background: #052e16; color: #4ade80; }
    .badge-none   { background: #1e293b; color: #64748b; }

    /* ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ */
    .refresh-btn {
      background: none;
      border: 1px solid #334155;
      color: #94a3b8;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      float: right;
    }
    .refresh-btn:hover { border-color: #60a5fa; color: #60a5fa; }
  </style>
</head>
<body>

<header>
  <div class="status-dot" id="status-dot"></div>
  <h1>ğŸ›¡ SIM Box íƒì§€ ì‹œìŠ¤í…œ ëŒ€ì‹œë³´ë“œ</h1>
</header>

<main>

  <!-- í†µê³„ ì¹´ë“œ -->
  <div class="cards">
    <div class="card">
      <div class="label">ì „ì²´ ì„¸ì…˜</div>
      <div class="value" id="stat-total">â€”</div>
    </div>
    <div class="card fraud">
      <div class="label">ğŸš¨ ì‚¬ê¸° ì˜ì‹¬</div>
      <div class="value" id="stat-fraud">â€”</div>
    </div>
    <div class="card normal">
      <div class="label">âœ… ì •ìƒ</div>
      <div class="value" id="stat-normal">â€”</div>
    </div>
    <div class="card latency">
      <div class="label">í‰ê·  ì§€ì—° (ms)</div>
      <div class="value" id="stat-latency">â€”</div>
    </div>
  </div>

  <!-- ì°¨íŠ¸ + ì—…ë¡œë“œ -->
  <div class="mid-row">

    <div class="panel">
      <h2>ì„¸ì…˜ë³„ ì§€í„° ë¶„í¬</h2>
      <canvas id="jitter-chart" height="180"></canvas>
    </div>

    <div class="panel">
      <h2>PCAP ì—…ë¡œë“œ</h2>
      <div class="upload-zone" onclick="document.getElementById('pcap-file').click()">
        <div style="font-size:32px">ğŸ“‚</div>
        <p id="file-name">íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì„¸ìš”<br>.pcap / .pcapng</p>
      </div>
      <input type="file" id="pcap-file" accept=".pcap,.pcapng">

      <div class="radio-group">
        <label><input type="radio" name="label" value="-1" checked> ë¯¸ë¼ë²¨</label>
        <label><input type="radio" name="label" value="0"> ì •ìƒ</label>
        <label><input type="radio" name="label" value="1"> ì‚¬ê¸°</label>
      </div>

      <button class="btn" id="upload-btn" onclick="uploadPcap()">ì—…ë¡œë“œ &amp; ë¶„ì„</button>
      <div id="upload-result"></div>
    </div>

  </div>

  <!-- ì„¸ì…˜ í…Œì´ë¸” -->
  <div class="panel">
    <h2>
      ìµœê·¼ ì„¸ì…˜
      <button class="refresh-btn" onclick="loadSessions()">â†» ìƒˆë¡œê³ ì¹¨</button>
    </h2>
    <table>
      <thead>
        <tr>
          <th>Session ID</th>
          <th>ì§€ì—° (ms)</th>
          <th>ì§€í„° (ms)</th>
          <th>íŒ¨í‚· ì†ì‹¤</th>
          <th>Seq ê°­</th>
          <th>ë¼ë²¨</th>
        </tr>
      </thead>
      <tbody id="session-tbody">
        <tr><td colspan="6" style="color:#475569;text-align:center;padding:24px">ë¡œë”© ì¤‘...</td></tr>
      </tbody>
    </table>
  </div>

</main>

<script>
  // â”€â”€ í†µê³„ ë¡œë“œ â”€â”€
  async function loadStats() {
    try {
      const res  = await fetch('/api/stats');
      const data = await res.json();
      document.getElementById('stat-total').textContent   = data.total;
      document.getElementById('stat-fraud').textContent   = data.fraud;
      document.getElementById('stat-normal').textContent  = data.normal;
      document.getElementById('stat-latency').textContent = data.avg_latency_ms;
    } catch(e) {
      document.getElementById('status-dot').style.background = '#f87171';
    }
  }

  // â”€â”€ ì„¸ì…˜ í…Œì´ë¸” â”€â”€
  async function loadSessions() {
    const tbody = document.getElementById('session-tbody');
    try {
      const res  = await fetch('/api/sessions?limit=30');
      const rows = await res.json();

      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="color:#475569;text-align:center;padding:24px">ì„¸ì…˜ ì—†ìŒ â€” PCAPì„ ì—…ë¡œë“œí•˜ì„¸ìš”</td></tr>';
        return;
      }

      tbody.innerHTML = rows.map(r => {
        const badge =
          r.label === 1  ? '<span class="badge badge-fraud">ì‚¬ê¸°</span>'  :
          r.label === 0  ? '<span class="badge badge-normal">ì •ìƒ</span>' :
                           '<span class="badge badge-none">ë¯¸ë¼ë²¨</span>';
        return `<tr>
          <td style="font-family:monospace;font-size:12px">${r.session_id}</td>
          <td>${r.avg_latency}</td>
          <td>${r.avg_jitter}</td>
          <td>${(r.packet_loss * 100).toFixed(1)}%</td>
          <td>${(r.seq_gap_rate * 100).toFixed(1)}%</td>
          <td>${badge}</td>
        </tr>`;
      }).join('');

      drawJitterChart(rows);
    } catch(e) {
      tbody.innerHTML = '<tr><td colspan="6" style="color:#f87171;text-align:center">API ì˜¤ë¥˜</td></tr>';
    }
  }

  // â”€â”€ ì§€í„° ì°¨íŠ¸ â”€â”€
  let jitterChart = null;
  function drawJitterChart(rows) {
    const labels = rows.map(r => r.session_id.slice(-8));
    const values = rows.map(r => r.avg_jitter);
    const colors = rows.map(r => r.label === 1 ? 'rgba(248,113,113,.8)' : 'rgba(74,222,128,.8)');

    const ctx = document.getElementById('jitter-chart').getContext('2d');
    if (jitterChart) jitterChart.destroy();
    jitterChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'ì§€í„° (ms)', data: values, backgroundColor: colors, borderRadius: 4 }] },
      options: {
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#475569', font: { size: 10 } }, grid: { color: '#1e293b' } },
          y: { ticks: { color: '#475569' }, grid: { color: '#334155' } },
        },
      },
    });
  }

  // â”€â”€ PCAP ì—…ë¡œë“œ â”€â”€
  document.getElementById('pcap-file').addEventListener('change', function() {
    const name = this.files[0]?.name || 'íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”';
    document.getElementById('file-name').textContent = name;
  });

  async function uploadPcap() {
    const fileInput = document.getElementById('pcap-file');
    const resultDiv = document.getElementById('upload-result');
    const btn       = document.getElementById('upload-btn');

    if (!fileInput.files.length) {
      resultDiv.innerHTML = '<span class="warn">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</span>';
      return;
    }

    const label = document.querySelector('input[name="label"]:checked').value;
    const form  = new FormData();
    form.append('file',  fileInput.files[0]);
    form.append('label', label);

    btn.disabled        = true;
    btn.textContent     = 'ë¶„ì„ ì¤‘...';
    resultDiv.innerHTML = '';

    try {
      const res  = await fetch('/api/upload-pcap', { method: 'POST', body: form });
      const data = await res.json();

      if (res.ok && data.status === 'ok') {
        resultDiv.innerHTML = `<span class="ok">âœ… ${data.inserted}ê°œ ì„¸ì…˜ ì €ì¥ ì™„ë£Œ</span>`;
        loadStats();
        loadSessions();
      } else {
        resultDiv.innerHTML = `<span class="warn">âš  ${data.message || data.error}</span>`;
      }
    } catch(e) {
      resultDiv.innerHTML = `<span class="err">âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨</span>`;
    } finally {
      btn.disabled    = false;
      btn.textContent = 'ì—…ë¡œë“œ & ë¶„ì„';
    }
  }

  // â”€â”€ ì´ˆê¸° ë¡œë“œ â”€â”€
  loadStats();
  loadSessions();
  setInterval(() => { loadStats(); loadSessions(); }, 30000);
</script>

</body>
</html>
